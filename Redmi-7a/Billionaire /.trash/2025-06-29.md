var apiEndPoint = "https://api4.apiapi.lat";
const darkModeSwitch = document.getElementById('darkModeSwitch');
const convertButton = document.getElementById('convert-button');
const koFiUrl = "/ko-fi/";
const urlInput = document.getElementById('url');
const restrictedTimezones = new Set(['-330', '-420', '-480', '-540']); // India and Indonesia
var isAPlaylistUrl = false;
var uniqueId = "";
var videoUrl = "";
var userTimeZone = "";
var timeZone = "";
var normalizedTimeZone = "";
var downloadLimit = "";
const europeTopCountriesTimeZones = {
    Germany: [
        "Europe/Berlin",
        "Europe/Busingen"
    ],
    France: [
        "Europe/Paris"
    ],
    Italy: [
        "Europe/Rome",
        "Europe/Vatican"
    ],
    Spain: [
        "Europe/Madrid",
        "Atlantic/Canary",
        "Africa/Ceuta"
    ]
};
const acceptedEuropeTimeZones = Object.values(europeTopCountriesTimeZones).flat();

function isUserFromIndiaByOffset() {
    try {
        return new Date().getTimezoneOffset() === -330;
    }
    catch {
        return false;
    }
}

function updateDonateLinks() {
    try {
        if (isUserFromIndiaByOffset()) {
            document.querySelector(".donate-button").href = koFiUrl;
        }
        else {
            document.querySelector(".donate-button").href = koFiUrl;
        }
    } catch (error) {
        console.log(error);
    }
}

function updateTimeZoneData() {
    try {
        userTimeZone = new Date().getTimezoneOffset().toString();
        timeZone = Intl.DateTimeFormat().resolvedOptions().timeZone;
        normalizedTimeZone = timeZone ? timeZone.toLowerCase() : "";
        downloadLimit = restrictedTimezones.has(userTimeZone) ? 5 : 100;
    } catch (error) {
        sendErrorLog(error, 'updateTimeZoneData');
    }
}


async function sendErrorLog(error, sender) {
    try {
        // const apiEndPointforErrorLog = "https://api2.apiapi.lat";
        // const endPoint = `${apiEndPointforErrorLog}/error-log/`;
        const response = await fetch('/error-log/', {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                error: error.toString(),
                sender: sender,
                url: videoUrl,
                timezone: timeZone,
            }),
        });

        const data = await response.json();
        return data;
    } catch (error) {
        console.log('Error:', error);
    }
}

function toggleMode(e) {
    try {
        e.preventDefault();
        const body = document.body;
        const modeButton = document.getElementById('darkModeSwitch');
        const savedTheme = getTheme();
        if (modeButton) {
            body.classList.toggle('dark-mode');
            if (savedTheme == 'light') {
                modeButton.textContent = "Light Mode â˜¼";
                modeButton.setAttribute('aria-label', 'Switch to light mode');
                removeTheme();
                // setTheme('light');
            } else {
                modeButton.textContent = "Dark Mode â˜¾";
                modeButton.setAttribute('aria-label', 'Switch to dark mode');
                setTheme('light');
            }
        }
    } catch (error) {
        console.log('Error:', error);
    }
}

function setTheme(theme) {
    localStorage.setItem('theme', theme);
}

function getTheme() {
    return localStorage.getItem('theme');
}

function removeTheme() {
    localStorage.removeItem('theme');
}

function initializeTheme() {
    try {
        if (darkModeSwitch) {
            darkModeSwitch.addEventListener('click', toggleMode);
        }
        const savedTheme = getTheme();
        const body = document.body;
        const modeButton = document.getElementById('darkModeSwitch');

        if (savedTheme === 'light') {
            if (modeButton) {
                body.classList.remove('dark-mode');
                modeButton.textContent = "Dark Mode â˜¾";
                modeButton.setAttribute('aria-label', 'Switch to dark mode');
            }
        } else {
            if (modeButton) {
                modeButton.textContent = "Light Mode â˜¼";
                modeButton.setAttribute('aria-label', 'Switch to light mode');
            }
        }
    }
    catch (error) {
        console.log('Error:', error);
    }
}

function isUrlValid(url) {
    try {
        const parsedUrl = new URL(url);
        const hostname = parsedUrl.hostname.toLowerCase();

        const hostnamePatterns = [
            /^(.+\.)?youtube\.com$/,             // youtube.com and any subdomain
            /^(.+\.)?youtube-nocookie\.com$/,    // youtube-nocookie.com and any subdomain
            /^youtu\.be$/,                        // youtu.be
            /^(.+\.)?googlevideo\.com$/,         // googlevideo.com and any subdomain
            /^(.+\.)?google\.com$/                // google.com and any subdomain (for redirects)
        ];

        const isAllowedHostname = hostnamePatterns.some(pattern => pattern.test(hostname));
        if (!isAllowedHostname) {
            return false;
        }

        if (hostname.endsWith('google.com')) {
            if (parsedUrl.pathname === '/url') {
                const qParam = parsedUrl.searchParams.get('q');
                if (!qParam) {
                    return false; // No 'q' parameter means invalid redirect URL
                }
                return isUrlValid(qParam);
            } else {
                return false; // Other Google URLs are not valid for downloading
            }
        }

        if (parsedUrl.searchParams.has('playlist')) {
            isAPlaylistUrl = true;
            return false; // Playlist URLs are not allowed
        }

        // const excludedParams = ['index', 'start_radio', 'listType'];
        // for (const param of excludedParams) {
        //     if (parsedUrl.searchParams.has(param)) {
        //         return false;
        //     }
        // }

        if (hostname.endsWith('googlevideo.com')) {
            if (!parsedUrl.searchParams.has('id') && !parsedUrl.searchParams.has('video_id')) {
                return false;
            }
        }
        return true;
    } catch (error) {
        return false;
    }
}

function getFileName(url) {
    const urlParts = url.split('/');
    const filename = urlParts[urlParts.length - 1];
    return filename;
}

function downloadFile() {
    let retryCount = 0;
    while (retryCount < 2) {
        retryCount += 1;
        try {
            const downloadButton = document.getElementById("download-button");
            const filePath = downloadButton.dataset.url;
            if (filePath == "") {
                alert("Server error. Please try again later!");
                window.location.reload();
            }
            else {
                const link = document.createElement('a');
                downloadButton.textContent = "Downloading...";
                downloadButton.style.pointerEvents = "none";
                link.href = filePath;
                link.download = getFileName(filePath);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                setTimeout(() => {
                    downloadButton.textContent = "Download";
                    downloadButton.style.pointerEvents = "auto";
                }, 5000);
                return true;
            }
        }
        catch (error) {
            sendErrorLog(error, 'downloadFile');
        }
    }

}

function getApiSubdomain() {
    var url = new URL(apiEndPoint);
    var hostnameParts = url.hostname.split('.');
    if (hostnameParts.length > 2) {
        var subdomain = hostnameParts.slice(0, -2).join('.');
        return subdomain;
    } else {
        return 'api';
    }

}

String.prototype.encodeDecode = function () {
    var nstr = '';
    for (var i = 0; i < this.length; i++) {
        nstr += String.fromCharCode(this.charCodeAt(i) ^ 1);
    }
    return nstr;
};

function ranHash() {
    const array = new Uint8Array(16);
    crypto.getRandomValues(array);
    const hashArray = Array.from(array, byte => byte.toString(16).padStart(2, '0'));
    const hashString = hashArray.join('');
    return hashString;
}

function encUrl(inputString, delimiter = ',') {
    const codePoints = [];
    for (let i = 0; i < inputString.length; i++) {
        const codePoint = inputString.charCodeAt(i);
        codePoints.push(codePoint);
    }
    const joinedCodePoints = codePoints.join(delimiter);
    const reversedResult = joinedCodePoints.split(delimiter).reverse().join(delimiter);
    return reversedResult;
}


function updateData(data) {
    try {
        const form = document.getElementById('form');
        form.style.flexDirection = 'row';
        form.style.flexWrap = 'wrap';
        const titleElement = document.getElementById('title');

        if (!form || !titleElement) {
            console.warn('updateData: One or more target elements not found.');
            return;
        }
        clearElementContent(form);
        const downloadButton = createButton({
            id: 'download-button',
            text: 'Download',
            dataset: { url: generateFileUrl(data["i"]) },
            ariaLabel: 'Download converted file',
        });
        const trimButton = createButton({
            id: 'trim-button',
            text: 'âœ‚ Cut ',
            dataset: { url: generateFileUrl(data["i"]) },
            ariaLabel: 'Trim and download the file',
        });
        form.appendChild(downloadButton);
        form.appendChild(trimButton);


        const donateButton = createButton({
            id: 'donate-button',
            text: 'â˜• Buy me a coffee',
            ariaLabel: 'Say thanks with a tip!',
        });
        form.appendChild(donateButton);

        const homeButton = createButton({
            id: 'home-button',
            text: 'Convert more',
            ariaLabel: 'Convert another video',
        });
        form.appendChild(homeButton);

        if (typeof data['t'] === 'string') {
            titleElement.textContent = `${data['t'].substring(0, 50)}...`;
        } else {
            console.warn('updateData: Invalid title data.');
            titleElement.textContent = 'Title not available.';
        }
        downloadFile();
        attachEventListeners();
    } catch (error) {
        sendErrorLog(error, 'updateData');
    }
}

function clearElementContent(element) {
    while (element.firstChild) {
        element.removeChild(element.firstChild);
    }
}

function createButton({ id, text, dataset = {}, ariaLabel = '' }) {
    const button = document.createElement('button');
    button.id = id;
    button.textContent = text;
    if (ariaLabel) {
        button.setAttribute('aria-label', ariaLabel);
    }
    for (const [key, value] of Object.entries(dataset)) {
        button.dataset[key] = value;
    }
    return button;
}


function generateFileUrl(uniqueId) {
    return `${apiEndPoint}/${ranHash()}/download/${uniqueId.encodeDecode()}/${ranHash()}/`;
}


function attachEventListeners() {
    const downloadButton = document.getElementById('download-button');
    const homeButton = document.getElementById('home-button');
    const donateButton = document.getElementById('donate-button');
    const trimButton = document.getElementById('trim-button');
    if (downloadButton && !downloadButton.dataset.listenerAttached) {
        downloadButton.addEventListener('click', downloadFile);
        downloadButton.dataset.listenerAttached = 'true';
    }

    if (homeButton && !homeButton.dataset.listenerAttached) {
        homeButton.addEventListener('click', redirectToHome);
        homeButton.dataset.listenerAttached = 'true';
    }
    if (donateButton && !donateButton.dataset.listenerAttached) {
        donateButton.addEventListener('click', redirectToDonatePage);
        donateButton.dataset.listenerAttached = 'true';
    }
    if (trimButton && !trimButton.dataset.listenerAttached) {
        trimButton.addEventListener('click', redirectToMediaCutterPage);
        trimButton.dataset.listenerAttached = 'true';
    }
}

function redirectToHome() {
    window.location.href = "/";
}

function redirectToDonatePage() {
    if (isUserFromIndiaByOffset()) {
        window.location.href = koFiUrl;
    }
    else {
        window.location.href = koFiUrl;
    }

}

function redirectToMediaCutterPage() {
    window.location.href = `/media-cutter/${getApiSubdomain()}/${uniqueId}/`;
}


async function checkStatus(uniqueId) {
    try {
        var randomHash1 = ranHash(),
            randomHash2 = ranHash(),
            endPoint = `${apiEndPoint}/${randomHash1}/status/${uniqueId.encodeDecode()}/${randomHash2}/`;

        const response = await fetch(endPoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                data: uniqueId,
            }),
        });
        const data = await response.json();
        return data;
    } catch (error) {
        sendErrorLog(error, 'checkStatus');
        return false;
    }
}
async function checkProgress(initData) {
    try {
        let count = 0;
        let titleUpdated = false;
        return new Promise((resolve) => {
            async function checkAgain() {
                count += 1;
                if (count <= 300) {
                    try {
                        let data = await checkStatus(initData["i"]);
                        if (data === false) {
                            setTimeout(checkAgain, 2000);
                            return;
                        }
                        if (data["s"] == "P") {
                            if (data['t'] && !titleUpdated) {
                                document.getElementById("title").textContent = data['t'].substring(0, 50) + "...";
                                titleUpdated = true;
                            }
                            if (count < 10) {
                                let progress = (count + 1) * 10;
                                if (progress == 100) {
                                    progress = 99;
                                }
                                document.querySelector("#progress").textContent = "Downloading..." + (progress) + "%";
                            }
                            setTimeout(checkAgain, 2000);
                        } else {
                            resolve(data);
                        }


                    } catch (error) {
                        sendErrorLog(error, 'checkAgain');
                        setTimeout(checkAgain, 2000);
                    }
                }
                else {
                    data["s"] = "E";
                    data["e"] = true;
                    resolve(data);
                }

            }
            checkAgain();
        });
    } catch (error) {
        sendErrorLog(error, 'checkProgress');
    }
}


async function initiate(videoUrl, downloadFormat, mp3Quality, mp4Quality) {
    try {
        var randomHash1 = ranHash(),
            randomHash2 = ranHash(),
            referer = document.referrer,
            endPoint = `${apiEndPoint}/${randomHash1}/init/${encUrl(videoUrl)}/${randomHash2}/`,
            encodedVideoUrl = videoUrl.encodeDecode();

        const response = await fetch(endPoint, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                data: encodedVideoUrl,
                format: downloadFormat,
                referer: referer,
                mp3Quality: mp3Quality,
                mp4Quality: mp4Quality,
                userTimeZone: userTimeZone,
            }),
        });

        const data = await response.json();
        return data;
    } catch (error) {
        return false;
        sendErrorLog(error, 'initiate');
    }
}

function checkInitData(initData) {
    try {
        if (initData["le"]) {
            alert("The video is longer than 3 hours. Please use our desktop app to download videos without limits.");
            window.location.href = "https://ytdfp.com/";
            // window.location.reload();
        }
        else if (initData['i'] == "blacklisted") {
            alert(`Daily limit reached! You can download up to ${downloadLimit} files per day. Try again tomorrow or use our desktop app for unlimited downloads!`);
            window.location.href = "https://ytdfp.com/";
            // window.location.reload();
        }
        else if (initData["e"]) {
            alert("Unexpected error occurred. Video is unavailable or an age restricted video. Please try again.");
            window.location.reload();
        }
        else if (initData['i'] == "invalid") {
            alert("Please enter a correct YouTube video URL.");
            window.location.reload();
        }
    } catch (error) {
        sendErrorLog(error, 'checkInitData');
    }
}

function getDownloadSection(data) {
    try {
        const form = document.getElementById('form');
        const titleElement = document.getElementById('title');

        if (!form || !titleElement) {
            console.warn('getDownloadSection: One or more target elements not found.');
            return;
        }

        clearElementContent(form);
        const progressParagraph = createElement({
            tag: 'p',
            id: 'progress',
            textContent: 'Downloading...',
            attributes: {
                'aria-live': 'polite',
            },
            classes: ['progress-message'],
        });
        form.appendChild(progressParagraph);

        const loadingSpinner = createElement({
            tag: 'div',
            id: 'loading-spinner',
            classes: ['loading-spinner'],
            attributes: {
                'aria-hidden': 'true',
            },
        });
        form.appendChild(loadingSpinner);
        titleElement.textContent = 'Loading video title...';
    } catch (error) {
        sendErrorLog(error, 'getDownloadSection');
    }
}

function createElement({ tag, id, textContent = '', classes = [], attributes = {} }) {
    const element = document.createElement(tag);

    if (id) {
        element.id = id;
    }

    if (textContent) {
        element.textContent = textContent;
    }

    if (classes.length > 0) {
        element.classList.add(...classes);
    }

    for (const [attr, value] of Object.entries(attributes)) {
        element.setAttribute(attr, value);
    }

    return element;
}


async function startConversion(videoUrl, downloadFormat, mp3Quality, mp4Quality) {
    getDownloadSection();
    let retryCount = 0;
    while (retryCount < 20) {
        retryCount += 1;
        try {
            let initData = await initiate(videoUrl, downloadFormat, mp3Quality, mp4Quality);
            if (initData !== false) {
                uniqueId = initData['i'];
                if (initData["s"] == "C") {
                    updateData(initData);
                }
                else {
                    checkInitData(initData);
                    let currentData = await checkProgress(initData);
                    if (currentData["s"] == "C") {
                        updateData(currentData);
                    }
                    else {
                        checkInitData(currentData);
                        if (currentData["s"] == "P") {
                            alert('Unexpected server error. Sorry for the inconvenience. Please try again!');
                            window.location.reload();
                        }
                    }
                }
                return true;
            }
        }
        catch (error) {
            sendErrorLog(error, 'startConversion');
        }
    }
    alert('Server error. Sorry for the inconvenience. Please try again!');
    window.location.reload();
}

async function logInvalidUrl(videoUrl) {
    var apiEndPointforInvalidUrlLog = "https://api2.apiapi.lat/invalid-url-log/";
    try {
        const response = await fetch(apiEndPointforInvalidUrlLog, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify({
                url: videoUrl,
            }),
        });
        return 0;
    }
    catch {
        return 0;
    }
}


function setApiEndPoint(downloadFormat, mp3Quality) {
    try {
        if (normalizedTimeZone.includes('america') || (normalizedTimeZone.includes('london'))) {
            if (downloadFormat == "1") {
                apiEndPoint = "https://api5.apiapi.lat";
            }
            else if (mp3Quality == "128") {
                apiEndPoint = "https://api.apiapi.lat";
            }
            else {
                apiEndPoint = "https://api.apiapi.lat";
            }
        }
        else if (acceptedEuropeTimeZones.includes(timeZone)) {
            apiEndPoint = "https://api6.apiapi.lat";
        }
        else if (normalizedTimeZone.includes('europe')) {
            apiEndPoint = "https://api7.apiapi.lat";
        }
        else {
            if (downloadFormat == "1") {
                apiEndPoint = "https://api5.apiapi.lat";
            }
            else {
                if (mp3Quality == "128") {
                    apiEndPoint = "https://api4.apiapi.lat";
                }
                else {
                    apiEndPoint = "https://api3.apiapi.lat";
                }
            }
        }
    }
    catch (error) {
        sendErrorLog(error, 'setApiEndPoint');
    }
}

function handleFormSubmit() {
    try {
        videoUrl = document.getElementById("url").value.trim();
        var downloadFormat = document.getElementById("format").value,
            mp3Quality = document.getElementById("mp3-quality").value,
            mp4Quality = document.getElementById("mp4-quality").value;
        setApiEndPoint(downloadFormat, mp3Quality);
        if (isUrlValid(videoUrl)) {
            startConversion(videoUrl, downloadFormat, mp3Quality, mp4Quality);
        }
        else {
            if (isAPlaylistUrl) {
                alert("It's very difficult to download playlists online. Please use our desktop app.");
                isAPlaylistUrl = false;
                windows.location.href = "https://ytdfp.com/";
            }
            else {
                alert("Please enter a valid YouTube video URL!");
            }
        }
    }
    catch (error) {
        sendErrorLog(error, 'handleFormSubmit');
    }
}

function handleFormatChange() {
    try {
        let mp3QualitySelector = document.getElementById('mp3');
        let mp4QualitySelector = document.getElementById('mp4');
        document.getElementById('format').addEventListener('change', function () {
            const selectedValue = this.value;
            if (selectedValue === '0') {
                mp4QualitySelector.style.display = 'none';
                mp3QualitySelector.style.display = 'block';
            } else {
                mp3QualitySelector.style.display = 'none';
                mp4QualitySelector.style.display = 'block';
            }
        });
    }
    catch (error) {
        sendErrorLog(error, 'handleFormatChange');
    }
}
window.onerror = function(message, source, lineno, colno, error) {
    try {
        const logData = {
            message: message,
            source: source,
            line: lineno,
            column: colno,
            error: error ? error.stack : "No stack trace",
            url: videoUrl,
            timezone: timeZone,
            sender: 'uncaught error'
        };

        fetch("/error-log/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
            },
            body: JSON.stringify(logData),
        }).catch(err => console.warn("Error log request failed:", err));

    } catch (err) {
        console.warn("Logging error to server failed:", err);
    }
};

document.addEventListener('DOMContentLoaded', () => {
    try {
        updateDonateLinks();
        updateTimeZoneData();
        initializeTheme();
        handleFormatChange();

        if (convertButton && urlInput) {
            const handleConvertClick = (e) => {
                e.preventDefault();
                handleFormSubmit();
            };

            const handleUrlKeydown = (e) => {
                if (e.key === 'Enter') {
                    e.preventDefault();
                    handleFormSubmit();
                }
            };
            convertButton.addEventListener('click', handleConvertClick);
            urlInput.addEventListener('keydown', handleUrlKeydown);
        }
    } catch (error) {
        sendErrorLog(error, 'DOMContentLoaded');
    }
});

